<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>ROS2 Pi 导航</title>
  <style>
    body{margin:0;font-family:Arial;background:#f5f5f5;display:flex;height:100vh}
    #map{flex:1;background:#000}
    #panel{width:280px;background:#222;color:#fff;padding:12px;box-sizing:border-box}
    #panel h3{margin:0 0 8px 0}
    #wayList{max-height:200px;overflow-y:auto;background:#333;padding:4px;border-radius:4px}
    #wayList div{padding:2px 0;cursor:pointer}
    #wayList div:hover{background:#444}
    button{width:100%;margin:4px 0;padding:6px;border:none;border-radius:4px;cursor:pointer}
    button:disabled{background:#555;cursor:not-allowed}
    .status{margin:6px 0;font-size:12px}
    .online{color:#2f2}
    .offline{color:#f22}
    label{font-size:12px}
  </style>

  <!-- 基础脚本，顺序不变 -->
  <script src="https://cdn.jsdelivr.net/npm/easeljs@1.0.2/lib/easeljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/eventemitter2@6.4.9/lib/eventemitter2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/roslib@1.3.0/build/roslib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ros2d@0.10.0/build/ros2d.min.js"></script>
</head>

<body>
  <div id="map"></div>
  <div id="panel">
    <h3>ROS2 Pi 导航</h3>
    <div id="status" class="status offline">Offline</div>
    <button id="btnConnect" onclick="connectROS()">Connect</button>

    <h4>航点列表</h4>
    <div id="wayList"></div>
    <button id="btnClear" onclick="clearWaypoints()">清空航点</button>
  </div>

  <script>
    /* ===== 新增：激光雷达层 ===== */
    ROS2D.LaserScan = function(options) {
      options = options || {};
      var ros           = options.ros;
      var topicName     = options.topic || '/scan';
      var rootObject    = options.rootObject;
      var strokeStyle   = options.strokeStyle || 'rgba(255,0,0,0.8)';
      var strokeWidth   = options.strokeWidth || 1;

      var scanTopic = new ROSLIB.Topic({
        ros: ros,
        name: topicName,
        messageType: 'sensor_msgs/LaserScan'
      });

      var shape = new createjs.Shape();
      rootObject.addChild(shape);

      scanTopic.subscribe(function(msg) {
        var g = shape.graphics.clear();
        g.setStrokeStyle(strokeWidth);
        g.beginStroke(strokeStyle);

        var angle = msg.angle_min;
        for (var i = 0; i < msg.ranges.length; i++) {
          var r   = msg.ranges[i];
          var x   = r * Math.cos(angle);
          var y   = r * Math.sin(angle);
          var pt  = viewer.scene.rosToGlobal({x:x, y:y});
          if (i === 0) g.moveTo(pt.x, pt.y);
          else         g.lineTo(pt.x, pt.y);
          angle += msg.angle_increment;
        }
        g.endStroke();
      });
    };
    /* ===== 激光雷达层结束 ===== */

    /* ---------- 原有全局变量 ---------- */
    let ros       = null;
    let viewer    = null;
    let waypoints = [];

    /* ---------- 连接 ROS ---------- */
    function connectROS(){
      if(ros) return;
      ros = new ROSLIB.Ros({url : 'ws://'+location.hostname+':9090'});
      ros.on('connection', ()=>{ setStatus('Online','online'); initViewer(); });
      ros.on('error',   e=>{ setStatus('Error','offline'); console.error(e); });
      ros.on('close',   ()=>{ setStatus('Offline','offline');
                               document.getElementById('btnConnect').disabled=false; });
    }
    function setStatus(txt,cls){
      const s=document.getElementById('status');
      s.textContent=txt; s.className='status '+cls;
      document.getElementById('btnConnect').disabled=true;
    }

    /* ---------- 初始化 Viewer：地图 + 代价地图 + 激光 + 箭头 ---------- */
    function initViewer(){
      viewer = new ROS2D.Viewer({
        divID : 'map',
        width : window.innerWidth-280,
        height: window.innerHeight
      });

      /* ① 静态地图 */
      const mapClient = new ROS2D.OccupancyGridClient({
        ros: ros, rootObject: viewer.scene, topic: '/map', continuous: true
      });

      /* ② 全局代价地图 红色 */
      new ROS2D.OccupancyGridClient({
        ros: ros, rootObject: viewer.scene, topic: '/global_costmap/costmap',
        continuous: true, opacity: 0.5,
        color: val => { const g=val/100; return {r:g,g:0,b:0}; }
      });

      /* ③ 局部代价地图 绿色 */
      new ROS2D.OccupancyGridClient({
        ros: ros, rootObject: viewer.scene, topic: '/local_costmap/costmap',
        continuous: true, opacity: 0.5,
        color: val => { const g=val/100; return {r:0,g:g,b:0}; }
      });

      /* ④ 激光雷达扫描线 */
      new ROS2D.LaserScan({
        ros: ros,
        rootObject: viewer.scene,
        topic: '/scan',
        strokeStyle: 'rgba(255,0,0,0.9)',   // 鲜红
        strokeWidth: 1
      });

      /* ⑤ 机器人箭头 */
      new ROS2D.NavigationArrow({
        ros: ros, rootObject: viewer.scene, topic: '/amcl_pose',
        stroke: 'yellow', fill: 'yellow', arrowLength: 0.6
      });

      /* ⑥ 第一张地图到来后居中 */
      mapClient.on('change', function() {
        viewer.scaleToDimensions(mapClient.currentGrid.width,
                                 mapClient.currentGrid.height);
        viewer.shift(mapClient.currentGrid.pose.position.x,
                     mapClient.currentGrid.pose.position.y);
      });

      /* ⑦ 单击地图 → 记录航点 */
      viewer.scene.on('stagemousedown', (evt)=>{
        const pos = viewer.scene.globalToRos(evt.stageX, evt.stageY);
        waypoints.push(pos);
        refreshWayList();
      });
    }

    /* ---------- 航点列表管理 ---------- */
    function refreshWayList(){
      const box=document.getElementById('wayList');
      box.innerHTML='';
      waypoints.forEach((p,i)=>{
        const div=document.createElement('div');
        div.textContent=`${i}: (${p.x.toFixed(2)}, ${p.y.toFixed(2)})`;
        div.onclick=()=>{ waypoints.splice(i,1); refreshWayList(); };
        box.appendChild(div);
      });
    }
    function clearWaypoints(){ waypoints=[]; refreshWayList(); }
  </script>
</body>
</html>